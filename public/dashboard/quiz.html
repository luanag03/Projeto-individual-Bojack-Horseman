<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Bojack | quiz</title>
    <link rel="stylesheet" href="../css/style.css">
</head>


<body>

    <header class="home">
        <div class="logo">
            <img src="../assets/icon/Logo_bojack.png" alt="Logo BoJack Horseman">
        </div>

        <div class="hello">
            <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
        </div>
        <nav class="nav-dash">
            <ul>
                <li><a href="./home.html">Home</a></li>
                <li><a href="./quiz.html">Quiz</a></li>
                <li><a href="./dashboard.html">Dashboard</a></li>
                <li><a href="./comunidade.html">Comunidade</a></li>
            </ul>
        </nav>

        <div class="sair">
            <a href="../index.html">
                <img src="../assets/icon/sair.png" alt="Ícone sair">
                Sair
            </a>
        </div>
    </header>


    <section class="content-secion">
        <h1>Quiz Bojack Horseman</h1>
        <div class="quiz-box">
            <h2 style="margin-bottom: 32px;" id="quizTitulo">Descubra seu Personagem !</h2>
            <button onclick="iniciarQuiz()" id="startBtn">Começar Quiz</button>

            <div style="width: 100%;" id="quizContainer" class="esconder">
                <div id="perguntaTexto" class="pergunta"></div>
                <form onchange="habilitarBotao()" id="alternativasContainer"></form>
                <button onclick="irParaProximaPergunta()" id="btnProxima">Próxima</button>
            </div>

            <div id="resultado" class="esconder">
                <h3>Suas respostas:</h3>
                <ul id="respostasUsuario"></ul>

            </div>

            <a href="./dashboard.html" id="btnDashboard" class="botao-dashboard"
                style="display:none; margin-top: 15px;">Ver
                Dashboard</a>

        </div>
        </div>
    </section>

</body>

</html>

<script>

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let perguntas = [];
    let respostas = [];
    let indicePergunta = 0;
    const fkQuiz = 1;

    let idUltimaResposta = null;

    const startBtn = document.getElementById("startBtn");
    const quizBox = document.getElementById("quizContainer");
    const perguntaTexto = document.getElementById("perguntaTexto");
    const alternativasContainer = document.getElementById("alternativasContainer");
    const proximaBtn = document.getElementById("btnProxima");
    const resultadoBox = document.getElementById("resultado");
    const listaRespostas = document.getElementById("respostasUsuario");
    proximaBtn.disabled = true;

    function habilitarBotao() {
        proximaBtn.disabled = false;
    };

    function iniciarQuiz() {
        fetch(`/quiz/buscarQuiz/${fkQuiz}`)
            .then(function (res) {

                res.json().then(data => {

                    const perguntasID = {};

                    for (let i = 0; i < data.length; i++) {
                        const item = data[i];

                        if (!perguntasID[item.pergunta_id]) {
                            perguntasID[item.pergunta_id] = {
                                texto: item.pergunta_texto,
                                alternativas: []
                            };
                        }

                        perguntasID[item.pergunta_id].alternativas.push({
                            letra: item.alternativa_letra,
                            texto: item.alternativa_texto
                        });
                    }

                    perguntas = Object.values(perguntasID);
                    respostas = [];
                    indicePergunta = 0;

                    startBtn.style.display = "none";
                    quizBox.classList.remove("esconder");
                    mostrarPergunta();
                })
            })
    }

    function mostrarPergunta() {
        const pergunta = perguntas[indicePergunta];
        perguntaTexto.textContent = pergunta.texto;
        alternativasContainer.innerHTML = "";
        proximaBtn.disabled = true;

        for (let i = 0; i < pergunta.alternativas.length; i++) {
            const alt = pergunta.alternativas[i];

            const id = `pergunta${indicePergunta}_alt${i}`;

            alternativasContainer.innerHTML += `
    <label class="alternativa">
      <input type="radio" name="alternativa" value="${alt.letra}">
      ${alt.letra}) ${alt.texto}
    </label> `;
        }
    }
  
  function irParaProximaPergunta() {
    proximaBtn.disabled = false

    var alternativas = document.getElementsByName("alternativa");
    var selecionada = null;

    for (var i = 0; i < alternativas.length; i++) {
      if (alternativas[i].checked) {
        selecionada = alternativas[i];
        break;
      }
    }

    if (selecionada) {
      respostas.push(selecionada.value);
      enviarResposta(selecionada.value);
    }

    indicePergunta++;

    if (indicePergunta < perguntas.length) {
      mostrarPergunta();
    } else {
      exibirResultado();
    }
  }

  function exibirResultado() {
    quizBox.classList.add("esconder");
    resultadoBox.classList.remove("esconder");
    listaRespostas.innerHTML = "";

    document.getElementById("btnDashboard").style.display = "block";


    for (let i = 0; i < respostas.length; i++) {
      listaRespostas.innerHTML += `<li>Pergunta ${i + 1}: ${respostas[i]}</li>`;
    }

    let contagem = {};
    for (let i = 0; i < respostas.length; i++) {
      let letra = respostas[i];
      if (contagem[letra] === undefined) {
        contagem[letra] = 1;
      } else {
        contagem[letra] += 1;
      }
    }

    let letras = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    let maiorQtd = 0;
    let letrasMaisEscolhidas = [];

    for (let i = 0; i < letras.length; i++) {
      let letra = letras[i];
      if (contagem[letra] === undefined) {
        contagem[letra] = 0;
      }

      if (contagem[letra] > maiorQtd) {
        maiorQtd = contagem[letra];
        letrasMaisEscolhidas = [letra];
      } else if (contagem[letra] === maiorQtd) {
        letrasMaisEscolhidas.push(letra);
      }
    }

    console.log(contagem);

    let letraEscolhida = "";
    if (letrasMaisEscolhidas.length === 1) {
      letraEscolhida = letrasMaisEscolhidas[0];
    } else {
      let indiceSorteado = Math.floor(Math.random() * letrasMaisEscolhidas.length);
      letraEscolhida = letrasMaisEscolhidas[indiceSorteado];
    }

    let caminhoImagem = ``;

    let personagemFinal = "";
    if (letraEscolhida === 'a') {
      personagemFinal = "Bojack Horseman";
      caminhoImagem = `../assets/imgs/BojackQuiz.jpg`;
    } else if (letraEscolhida === 'b') {
      personagemFinal = "Sarah Lynn";
      caminhoImagem = `../assets/imgs/sarah-lynnQuiz.webp`;
    } else if (letraEscolhida === 'c') {
      personagemFinal = "Princess Carolyn";
      caminhoImagem = `../assets/imgs/princesacarolineQuiz.png`;
    } else if (letraEscolhida === 'd') {
      personagemFinal = "Mr. Peanutbutter";
      caminhoImagem = `../assets/imgs/mrpeantbutterQuiz.jpeg`;
    } else if (letraEscolhida === 'e') {
      personagemFinal = "Diane";
      caminhoImagem = `../assets/imgs/dianeQuiz.jpg`;
    } else if (letraEscolhida === 'f') {
      personagemFinal = "Beatrice Horseman";
      caminhoImagem = `../assets/imgs/senhorahorsemanQuiz.png`;
    } else if (letraEscolhida === 'g') {
      personagemFinal = "Hollyhock";
      caminhoImagem = `../assets/imgs/hollyhockQuiz.jpg`;
    } else if (letraEscolhida === 'h') {
      personagemFinal = "Todd Chavez";
      caminhoImagem = `../assets/imgs/toddQuiz.jpg`;
    } else {
      personagemFinal = "Personagem desconhecido";
      caminhoImagem = `../assets/imgs/`;
    }

    fetch(`/quiz/personagem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ personagemFinal: personagemFinal })
    })
      .then(res => {
        if (!res.ok) throw new Error("Erro ao buscar personagem no banco.");
        return res.json();
      })
      .then(personagem => {
   
        listaRespostas.innerHTML += `
      <img src="${caminhoImagem}" alt="Imagem do personagem ${personagem.personagem}" style="width: 400px; margin-top: 15px;" />
      <li><b>Seu personagem é:</b> ${personagem.personagem}</li>
      <li><b>Descrição:</b> ${personagem.Texto}</li>
      <br> `;

        const idUsuario = sessionStorage.ID_USUARIO;

        fetch('/quiz/salvar-personagem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idUsuario: idUsuario,
            idPersonagem: personagem.idPersonagem
          })
        })
          .then(res => {
            if (!res.ok) throw new Error("Erro ao salvar personagem no usuário.");
            console.log("Personagem salvo com sucesso!");
          })
          .catch(erro => {
            console.error("Erro ao salvar personagem no usuário:", erro);
          });
      })

  }

  function enviarResposta(letra) {
    const fkUsuario = sessionStorage.getItem("ID_USUARIO");
    if (!fkUsuario) {
      alert("Usuário não autenticado.");
      return;
    }

    fetch("/quiz/resposta/alternativa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fkUsuario, letra })
    })
      .then(res => {
        console.log(res);

      })
      .catch(erro => {
        console.error(erro);
        alert("Erro ao enviar respostas.");
      });
  }


</script>